<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GradeMaster Pro (Online)</title>
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Maps for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            #root > div { display: none; } /* Hide app UI */
            #print-portal { display: block; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="print-portal"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, 
            onSnapshot, query, orderBy, Timestamp, writeBatch, getDocs 
        } from 'firebase/firestore';
        import { 
            LayoutDashboard, Plus, FileText, Settings, Printer, Camera, 
            BarChart3, Users, Save, ArrowLeft, Trash2, Check, X, 
            Search, Download, Upload, ScanLine, FileSpreadsheet, Home,
            Grid3X3, Copy, Layers
        } from 'lucide-react';

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBEFsVxwgVlIt4sqQrTRFDRSMofjlIpx3U",
            authDomain: "omr-test-a9a6d.firebaseapp.com",
            projectId: "omr-test-a9a6d",
            storageBucket: "omr-test-a9a6d.firebasestorage.app",
            messagingSenderId: "710542600974",
            appId: "1:710542600974:web:187c4ca5d9bbbf6704855f",
            measurementId: "G-J6BVS5029Q"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'grade-master-pro'; // App Namespace

        const CHOICES = ['A', 'B', 'C', 'D', 'E'];
        const EXAM_SETS = ['A', 'B', 'C', 'D'];
        const QUESTION_OPTIONS = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120];

        // --- Helper Functions ---
        const getLayoutConfig = (totalQuestions) => {
            if (totalQuestions <= 50) {
                const mid = Math.ceil(totalQuestions / 2);
                return {
                    cols: 2,
                    ranges: [
                        { start: 1, end: mid, x: 0.12, w: 0.35 },
                        { start: mid + 1, end: totalQuestions, x: 0.58, w: 0.35 }
                    ]
                };
            } else {
                const perCol = Math.ceil(totalQuestions / 4);
                return {
                    cols: 4,
                    ranges: [
                        { start: 1, end: perCol, x: 0.05, w: 0.20 },
                        { start: perCol + 1, end: perCol * 2, x: 0.28, w: 0.20 },
                        { start: perCol * 2 + 1, end: perCol * 3, x: 0.52, w: 0.20 },
                        { start: perCol * 3 + 1, end: totalQuestions, x: 0.75, w: 0.20 }
                    ]
                };
            }
        };

        const analyzePaperImage = (ctx, width, height, questionCount, threshold) => {
            const paper = { x: width * 0.05, y: height * 0.05, w: width * 0.9, h: height * 0.9 };
            const getB = (x, y) => {
                try {
                    const d = ctx.getImageData(x - 2, y - 2, 5, 5).data;
                    let s = 0; for (let i = 0; i < d.length; i += 4) s += (d[i] + d[i + 1] + d[i + 2]) / 3;
                    return s / (d.length / 4);
                } catch { return 255; }
            };

            // 1. Scan ID
            const idArea = { x: paper.x + paper.w * 0.65, y: paper.y + paper.h * 0.12, w: paper.w * 0.25, h: paper.h * 0.15 };
            let studentId = "";
            for (let c = 0; c < 5; c++) {
                let min = 255, digit = "?";
                for (let r = 0; r < 10; r++) {
                    const bx = idArea.x + c * (idArea.w / 5) + (idArea.w / 10);
                    const by = idArea.y + r * (idArea.h / 10) + (idArea.h / 20);
                    const b = getB(bx, by);
                    if (b < min) { min = b; if (min < threshold) digit = r.toString(); }
                }
                studentId += digit;
            }

            // 2. Scan Set
            const setArea = { x: paper.x + paper.w * 0.45, y: paper.y + paper.h * 0.15, w: paper.w * 0.15, h: paper.h * 0.05 };
            let detectedSet = null;
            const setGap = setArea.w / 4;
            let minSetB = 255;
            for(let i=0; i<4; i++) {
                const bx = setArea.x + i*setGap + setGap/2;
                const by = setArea.y + setArea.h/2;
                const b = getB(bx, by);
                if(b < minSetB) { 
                    minSetB = b; 
                    if(minSetB < threshold) detectedSet = EXAM_SETS[i]; 
                }
            }

            // 3. Scan Questions
            const layout = getLayoutConfig(questionCount);
            const answers = {};
            const qZoneY = paper.y + paper.h * 0.35;
            const qZoneH = paper.h * 0.55;

            layout.ranges.forEach(range => {
                const colX = paper.x + (paper.w * range.x);
                const colW = paper.w * range.w;
                const count = range.end - range.start + 1;
                const rowH = qZoneH / count; 
                const gap = colW / 5;

                for(let i=0; i<count; i++) {
                    const qNum = range.start + i;
                    let best = "-", min = 255;
                    for(let c=0; c<5; c++) {
                        const bx = colX + c*gap + gap/2;
                        const by = qZoneY + i*rowH + rowH/2;
                        const b = getB(bx, by);
                        if(b < min) { min=b; if(min < threshold) best = CHOICES[c]; }
                    }
                    answers[qNum] = best;
                }
            });

            return { studentId, answers, detectedSet };
        };

        // --- Components ---

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            const [selectedQuiz, setSelectedQuiz] = useState(null);

            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                return onAuthStateChanged(auth, setUser);
            }, []);

            if (!user) return (
                <div className="h-screen flex flex-col items-center justify-center text-blue-600">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <div>GradeMaster Loading...</div>
                </div>
            );

            return (
                <div className="flex flex-col min-h-screen">
                    <div className="flex-grow">
                        {view === 'home' && <HomeView user={user} onSelect={(q) => { setSelectedQuiz(q); setView('quiz'); }} />}
                        {view === 'students' && <StudentView user={user} />}
                        {view === 'quiz' && selectedQuiz && <QuizWorkspace user={user} quiz={selectedQuiz} onBack={() => setView('home')} />}
                    </div>
                    {view !== 'quiz' && (
                        <div className="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 z-50">
                            <NavButton icon={<Home/>} label="หน้าหลัก" active={view === 'home'} onClick={() => setView('home')} />
                            <NavButton icon={<Users/>} label="นักเรียน" active={view === 'students'} onClick={() => setView('students')} />
                        </div>
                    )}
                </div>
            );
        }

        const NavButton = ({icon, label, active, onClick}) => (
            <button onClick={onClick} className={`flex flex-col items-center w-full py-1 ${active ? 'text-blue-600' : 'text-gray-400'}`}>
                {icon} <span className="text-[10px] font-bold mt-1">{label}</span>
            </button>
        );

        function HomeView({ user, onSelect }) {
            const [quizzes, setQuizzes] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [name, setName] = useState("");
            const [qCount, setQCount] = useState(20);

            useEffect(() => {
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), orderBy('date', 'desc'));
                return onSnapshot(q, (snap) => setQuizzes(snap.docs.map(d => {
                    const data = d.data();
                    const answerKeys = data.answerKeys || { 'A': data.answerKey || {} };
                    return { id: d.id, ...data, answerKeys };
                })));
            }, [user]);

            const create = async () => {
                if(!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), {
                    name, date: Timestamp.now(), questions: qCount, answerKeys: {'A':{}}, threshold: 110
                });
                setShowModal(false); setName("");
            };

            const del = async (id, e) => {
                e.stopPropagation();
                if(confirm("ยืนยันลบ?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quizzes', id));
            }

            return (
                <div className="p-6 pb-20 max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-black text-gray-800 flex gap-2"><ScanLine className="text-blue-600"/> GradeMaster</h1>
                        <button onClick={() => setShowModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg flex gap-2"><Plus size={20}/> สร้าง</button>
                    </div>
                    <div className="grid gap-4 md:grid-cols-2">
                        {quizzes.map(q => (
                            <div key={q.id} onClick={() => onSelect(q)} className="bg-white p-5 rounded-2xl shadow-sm border hover:shadow-md cursor-pointer relative group">
                                <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500 rounded-l-2xl"></div>
                                <div className="ml-3">
                                    <div className="flex justify-between">
                                        <h3 className="font-bold text-lg">{q.name}</h3>
                                        <button onClick={(e)=>del(q.id, e)} className="text-gray-300 hover:text-red-500"><Trash2 size={18}/></button>
                                    </div>
                                    <div className="flex gap-3 text-sm text-gray-500 mt-2">
                                        <span className="bg-gray-100 px-2 rounded flex items-center gap-1"><FileText size={12}/> {q.questions} ข้อ</span>
                                        <span>{q.date?.seconds ? new Date(q.date.seconds*1000).toLocaleDateString('th-TH') : ''}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {showModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                                <h3 className="text-xl font-bold mb-4">สร้างการสอบใหม่</h3>
                                <input className="w-full border p-3 rounded-lg mb-4" placeholder="ชื่อวิชา" value={name} onChange={e => setName(e.target.value)} autoFocus />
                                <div className="mb-4">
                                    <label className="text-xs font-bold text-gray-500 mb-2 block">จำนวนข้อ</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {QUESTION_OPTIONS.map(n => (
                                            <button key={n} onClick={() => setQCount(n)} className={`py-1 rounded border text-xs font-bold ${qCount===n?'bg-blue-50 border-blue-500 text-blue-600':'bg-white text-gray-500'}`}>{n}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowModal(false)} className="flex-1 py-2 bg-gray-100 rounded-lg font-bold text-gray-500">ยกเลิก</button>
                                    <button onClick={create} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">สร้าง</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        function StudentView({ user }) {
            const [students, setStudents] = useState([]);
            const [mode, setMode] = useState('list');
            const [bulk, setBulk] = useState("");

            useEffect(() => {
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'students'), orderBy('studentId'));
                return onSnapshot(q, (snap) => setStudents(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
            }, [user]);

            const importBulk = async () => {
                const batch = writeBatch(db);
                bulk.split('\n').forEach(l => {
                    const p = l.trim().split(/\s+/);
                    if(p.length >= 2 && p[0].length === 5) {
                        const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'students'));
                        batch.set(ref, { studentId: p[0], name: p.slice(1).join(' '), classRoom: '-' });
                    }
                });
                await batch.commit();
                setMode('list'); setBulk("");
            }

            const del = async (id) => { if(confirm("ลบ?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'students', id)); }

            return (
                <div className="p-6 pb-20 max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-black text-gray-800">นักเรียน ({students.length})</h2>
                        <button onClick={() => setMode('bulk')} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex gap-2"><Upload size={18}/> นำเข้า</button>
                    </div>
                    
                    {mode === 'bulk' && (
                        <div className="bg-white p-4 rounded-xl shadow-lg mb-6 relative">
                            <button onClick={()=>setMode('list')} className="absolute top-2 right-2"><X/></button>
                            <h3 className="font-bold mb-2">นำเข้า (รหัส เว้นวรรค ชื่อ)</h3>
                            <textarea className="w-full h-32 border p-2 rounded" value={bulk} onChange={e=>setBulk(e.target.value)}></textarea>
                            <button onClick={importBulk} className="w-full bg-blue-600 text-white py-2 rounded mt-2 font-bold">ยืนยัน</button>
                        </div>
                    )}

                    <div className="bg-white rounded-xl shadow overflow-hidden">
                        {students.map(s => (
                            <div key={s.id} className="flex justify-between p-3 border-b last:border-0 hover:bg-gray-50">
                                <div><span className="font-mono font-bold text-blue-600 mr-3">{s.studentId}</span>{s.name}</div>
                                <button onClick={()=>del(s.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function QuizWorkspace({ user, quiz, onBack }) {
            const [tab, setTab] = useState('scan');
            return (
                <div className="h-screen flex flex-col bg-gray-100 fixed inset-0 z-50">
                    <div className="bg-white px-4 py-3 shadow-sm border-b flex justify-between items-center shrink-0 z-40">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack} className="p-1 hover:bg-gray-100 rounded-full"><ArrowLeft/></button>
                            <div>
                                <div className="font-black text-lg leading-none">{quiz.name}</div>
                                <div className="text-xs text-gray-500 mt-1">{quiz.questions} ข้อ</div>
                            </div>
                        </div>
                        <div className="hidden md:flex gap-1">
                            <TabBtn id="key" label="เฉลย" active={tab} set={setTab} />
                            <TabBtn id="sheet" label="กระดาษ" active={tab} set={setTab} />
                            <TabBtn id="scan" label="สแกน" active={tab} set={setTab} />
                            <TabBtn id="results" label="ผลสอบ" active={tab} set={setTab} />
                        </div>
                    </div>
                    <div className="flex-grow overflow-hidden relative bg-gray-50">
                        {tab === 'key' && <KeyTab user={user} quiz={quiz} />}
                        {tab === 'sheet' && <SheetTab quiz={quiz} />}
                        {tab === 'scan' && <ScannerTab user={user} quiz={quiz} />}
                        {tab === 'results' && <ResultsTab user={user} quiz={quiz} />}
                    </div>
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around p-2 pb-safe shadow-lg z-50">
                        <MobileTabBtn id="key" icon={<Settings/>} label="เฉลย" active={tab} set={setTab} />
                        <MobileTabBtn id="sheet" icon={<Printer/>} label="กระดาษ" active={tab} set={setTab} />
                        <MobileTabBtn id="scan" icon={<Camera/>} label="สแกน" active={tab} set={setTab} isMain />
                        <MobileTabBtn id="results" icon={<BarChart3/>} label="ผลสอบ" active={tab} set={setTab} />
                    </div>
                </div>
            )
        }

        const TabBtn = ({id, label, active, set}) => (
            <button onClick={()=>set(id)} className={`px-4 py-2 rounded-lg text-sm font-bold ${active===id?'bg-blue-50 text-blue-600':'text-gray-500'}`}>{label}</button>
        );
        const MobileTabBtn = ({id, icon, label, active, set, isMain}) => (
            <button onClick={()=>set(id)} className={`flex flex-col items-center w-full ${active?'text-blue-600':'text-gray-400'}`}>
                {isMain ? <div className={`p-3 rounded-full -mt-6 shadow-lg border-4 border-gray-100 ${active?'bg-blue-600 text-white':'bg-white text-gray-500'}`}>{icon}</div> : icon}
                <span className="text-[10px] font-bold mt-1">{label}</span>
            </button>
        );

        // --- QUIZ TABS ---

        function KeyTab({ user, quiz }) {
            const [set, setSet] = useState('A');
            const [keys, setKeys] = useState(quiz.answerKeys || {'A':{}});
            
            const updateKey = (q, val) => {
                const newKeys = { ...keys, [set]: { ...keys[set], [q]: val } };
                setKeys(newKeys);
            }
            
            const save = async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quizzes', quiz.id), { answerKeys: keys });
                alert("บันทึกแล้ว");
            }

            return (
                <div className="h-full overflow-y-auto p-4 pb-24 max-w-3xl mx-auto">
                    <div className="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                        <div className="flex gap-2">
                            {EXAM_SETS.map(s => (
                                <button key={s} onClick={()=>setSet(s)} className={`w-8 h-8 rounded font-bold shadow ${set===s?'bg-blue-600 text-white':'bg-white text-gray-500'}`}>{s}</button>
                            ))}
                        </div>
                        <button onClick={save} className="bg-green-600 text-white px-6 py-1.5 rounded-lg font-bold shadow">บันทึก</button>
                    </div>
                    <div className="grid grid-cols-5 gap-2">
                        {Array.from({length: quiz.questions}, (_, i) => i+1).map(q => (
                            <div key={q} className="bg-white p-2 rounded border text-center">
                                <div className="text-[10px] font-bold text-gray-400">{q}</div>
                                <select 
                                    className={`w-full text-center font-bold outline-none ${keys[set]?.[q] ? 'text-green-600':'text-gray-300'}`}
                                    value={keys[set]?.[q] || '-'}
                                    onChange={(e)=>updateKey(q, e.target.value)}
                                >
                                    <option value="-">-</option>
                                    {CHOICES.map(c=><option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        ))}
                    </div>
                </div>
            )
        }

        function SheetTab({ quiz }) {
            const [size, setSize] = useState('A4');
            const layout = getLayoutConfig(quiz.questions);
            const style = size === 'A4' ? { width: '210mm', minHeight: '297mm' } : { width: '148mm', minHeight: '210mm' };

            const print = () => {
                const content = document.getElementById('sheet-preview').innerHTML;
                const portal = document.getElementById('print-portal');
                portal.innerHTML = `<div class="p-0 m-0 w-full h-full">${content}</div>`;
                window.print();
                portal.innerHTML = '';
            }

            return (
                <div className="h-full flex flex-col items-center bg-gray-100 p-4 pb-24 overflow-y-auto">
                    <div className="mb-4 flex gap-4 print:hidden">
                        <div className="bg-white p-1 rounded flex">
                            <button onClick={()=>setSize('A4')} className={`px-3 rounded ${size==='A4'?'bg-gray-200 font-bold':''}`}>A4</button>
                            <button onClick={()=>setSize('A5')} className={`px-3 rounded ${size==='A5'?'bg-gray-200 font-bold':''}`}>A5</button>
                        </div>
                        <button onClick={print} className="bg-gray-900 text-white px-4 py-1 rounded font-bold shadow flex gap-2"><Printer size={18}/> พิมพ์</button>
                    </div>
                    
                    <div id="sheet-preview">
                        <div style={style} className={`bg-white shadow-xl p-8 relative box-border mx-auto text-black print:w-full print:shadow-none`}>
                            <div className="absolute top-6 left-6 w-5 h-5 bg-black"></div>
                            <div className="absolute top-6 right-6 w-5 h-5 bg-black"></div>
                            <div className="absolute bottom-6 left-6 w-5 h-5 bg-black"></div>
                            <div className="absolute bottom-6 right-6 w-5 h-5 bg-black"></div>

                            <div className="mx-8 mt-4 border-b-2 border-black pb-2 flex justify-between items-start">
                                <div>
                                    <h1 className="text-3xl font-black uppercase">ANSWER SHEET</h1>
                                    <div className="mt-2 space-y-1 w-64">
                                        <div className="flex justify-between border-b border-gray-400"><span className="text-[10px] font-bold">NAME</span></div>
                                        <div className="flex justify-between border-b border-gray-400"><span className="text-[10px] font-bold">DATE</span></div>
                                    </div>
                                    <div className="mt-3 flex items-center gap-2 border border-black p-1 rounded w-fit">
                                        <span className="font-bold text-[9px]">TEST FORM:</span>
                                        {EXAM_SETS.map(s => <div key={s} className="w-4 h-4 rounded-full border border-black flex items-center justify-center text-[8px] font-bold text-gray-300">{s}</div>)}
                                    </div>
                                </div>
                                <div className="border border-black p-2">
                                    <div className="text-[10px] font-black text-center mb-1">STUDENT ID</div>
                                    <div className="grid grid-cols-5 gap-1">
                                        {Array.from({length:10},(_,r)=><React.Fragment key={r}>{Array.from({length:5}).map((_,c)=><div key={c} className="w-4 h-4 rounded-full border border-gray-400 flex items-center justify-center text-[8px] text-gray-400">{r}</div>)}</React.Fragment>)}
                                    </div>
                                </div>
                            </div>

                            <div className="mx-8 mt-6 flex justify-between gap-8">
                                {layout.ranges.map((range, idx) => (
                                    <div key={idx} className="flex-1">
                                        {Array.from({ length: range.end - range.start + 1 }, (_, i) => range.start + i).map(q => (
                                            <div key={q} className="flex items-center gap-2 mb-1">
                                                <span className="font-bold w-5 text-right font-mono text-[10px]">{q}</span>
                                                <div className="flex gap-1.5">
                                                    {CHOICES.map(c => <div key={c} className="w-5 h-5 rounded-full border border-gray-600 flex items-center justify-center text-[8px] font-bold text-gray-300">{c}</div>)}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        function ScannerTab({ user, quiz }) {
            const videoRef = useRef(null);
            const [result, setResult] = useState(null);
            const [scanning, setScanning] = useState(false);
            const [students, setStudents] = useState([]);
            const [threshold, setThreshold] = useState(110);

            useEffect(() => {
                getDocs(query(collection(db, 'artifacts', appId, 'users', user.uid, 'students'))).then(s => setStudents(s.docs.map(d=>d.data())));
                navigator.mediaDevices.getUserMedia({video:{facingMode:'environment', width: {ideal: 1920}, height: {ideal: 1080}}})
                    .then(s => { if(videoRef.current) videoRef.current.srcObject = s; })
                    .catch(e => console.error(e));
            }, []);

            const scan = () => {
                if(scanning || !videoRef.current) return;
                setScanning(true);
                const cvs = document.createElement('canvas');
                cvs.width = videoRef.current.videoWidth;
                cvs.height = videoRef.current.videoHeight;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(videoRef.current, 0, 0);

                const { studentId, answers, detectedSet } = analyzePaperImage(ctx, cvs.width, cvs.height, quiz.questions, threshold);
                
                // Grading
                const examSet = detectedSet || 'A';
                const key = quiz.answerKeys[examSet] || {};
                let score = 0;
                Object.keys(answers).forEach(q => { if(answers[q] === key[q]) score++; });

                const st = students.find(s => s.studentId === studentId);
                setResult({ studentId, score, examSet, answers, matchedName: st ? st.name : null });
                if(navigator.vibrate) navigator.vibrate(200);
                setScanning(false);
            }

            const save = async () => {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes', quiz.id, 'results'), { ...result, timestamp: Timestamp.now() });
                setResult(null);
            }

            return (
                <div className="h-full bg-black relative flex flex-col">
                    <div className="relative flex-grow overflow-hidden">
                        <video ref={videoRef} autoPlay muted playsInline className="absolute inset-0 w-full h-full object-cover opacity-90" />
                        <div className="absolute inset-0 pointer-events-none z-10 p-4">
                            <div className="w-full h-full border-[20px] border-black/60 relative">
                                <div className="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-green-400 -m-1"></div>
                                <div className="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-green-400 -m-1"></div>
                                <div className="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-green-400 -m-1"></div>
                                <div className="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-green-400 -m-1"></div>
                                <div className="absolute top-1/4 right-8 text-yellow-200 text-xs font-bold bg-black/50 px-2">ID</div>
                                <div className="absolute top-[15%] left-[45%] text-orange-200 text-xs font-bold bg-black/50 px-2">SET</div>
                            </div>
                        </div>
                        <div className="absolute bottom-24 w-full flex flex-col items-center gap-4 z-20">
                            <div className="bg-black/50 px-3 py-1 rounded-full text-white text-xs flex gap-2">
                                <span>Light:</span><input type="range" min="50" max="200" value={threshold} onChange={e=>setThreshold(Number(e.target.value))} className="w-20"/>
                            </div>
                            <button onClick={scan} disabled={scanning} className="w-20 h-20 bg-white rounded-full border-4 border-gray-400 flex items-center justify-center active:scale-95 shadow-2xl">
                                <div className="w-16 h-16 bg-red-600 rounded-full border-2 border-white"></div>
                            </button>
                        </div>
                    </div>
                    {result && (
                        <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-sm animate-in zoom-in overflow-hidden shadow-2xl">
                                <div className={`p-6 text-center ${result.score >= quiz.questions/2 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                    <div className="absolute top-2 right-2 bg-white/20 px-2 rounded text-xs font-bold">Set {result.examSet}</div>
                                    <div className="text-6xl font-black">{Math.round(result.score/quiz.questions*100)}%</div>
                                    <div className="font-bold text-xl">{result.score} / {quiz.questions}</div>
                                    <div className="mt-2 bg-black/20 p-2 rounded">
                                        <div className="text-lg font-bold">{result.matchedName || 'Unknown Student'}</div>
                                        <div className="text-xs font-mono">{result.studentId}</div>
                                    </div>
                                </div>
                                <div className="p-4 flex gap-2">
                                    <button onClick={()=>setResult(null)} className="flex-1 py-3 bg-gray-100 rounded font-bold text-gray-500">ยกเลิก</button>
                                    <button onClick={save} className="flex-1 py-3 bg-blue-600 text-white rounded font-bold">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        function ResultsTab({ user, quiz }) {
            const [results, setResults] = useState([]);
            const [students, setStudents] = useState({});

            useEffect(() => {
                getDocs(query(collection(db, 'artifacts', appId, 'users', user.uid, 'students'))).then(s => {
                    const map = {}; s.docs.forEach(d=>map[d.data().studentId]=d.data());
                    setStudents(map);
                });
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes', quiz.id, 'results'), orderBy('timestamp', 'desc'));
                return onSnapshot(q, (s) => setResults(s.docs.map(d=>({id:d.id, ...d.data()}))));
            }, []);

            const csv = () => {
                const head = "ID,Name,Set,Score,Max,%\n";
                const rows = results.map(r => `${r.studentId},${students[r.studentId]?.name||'-'},${r.examSet},${r.score},${quiz.questions},${Math.round(r.score/quiz.questions*100)}`).join('\n');
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([head+rows])); a.download="report.csv"; a.click();
            }

            return (
                <div className="p-4 overflow-y-auto pb-24 h-full">
                    <div className="flex justify-between mb-4">
                        <h2 className="font-bold text-xl">ผลการสอบ ({results.length})</h2>
                        <button onClick={csv} className="bg-green-600 text-white px-3 py-1 rounded font-bold text-sm shadow">Export CSV</button>
                    </div>
                    <div className="bg-white rounded-xl shadow border overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 font-bold border-b"><tr><th className="p-3">ID</th><th className="p-3">Name</th><th className="p-3">Set</th><th className="p-3 text-right">Score</th></tr></thead>
                            <tbody>
                                {results.map(r => (
                                    <tr key={r.id} className="border-b last:border-0 hover:bg-gray-50">
                                        <td className="p-3 font-mono text-blue-600">{r.studentId}</td>
                                        <td className="p-3">{students[r.studentId]?.name || '-'}</td>
                                        <td className="p-3 text-gray-400 font-bold">{r.examSet}</td>
                                        <td className="p-3 text-right font-black">{r.score}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
